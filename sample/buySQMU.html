<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
<title>Crypto Payment 2.1</title>
  <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet">
  <script src="https://assets.calendly.com/assets/external/widget.js" type="text/javascript" async></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>

  <style>
    /* match layout tweaks from Metamask 2.0 */
    #layout { display:flex; flex-wrap:wrap; gap:1em; justify-content:center; align-items:flex-start; }
    #info { flex:1 1 60%; min-width:300px; }
    #widget { text-align:center; flex:1 1 40%; min-width:280px; }
    #sqmu-payment-guide { margin:0 auto; max-width:640px; }
    #widget > * { margin:0.6em 0; }
    label { display:block; margin:0.5em 0 0.2em; }
    select,
    input[type=email],
    input[type=text] {
      font: inherit;
      padding: 0.6em;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
    }
    #qr img { margin:0 auto; }
    .required::after { content:'*'; color:var(--wp--preset--color--primary,#d63638); margin-left:0.25em; }
    #msg, #tx-details { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <div id="layout">
    <div id="widget">
  <h3 id="prop-title"></h3>
  <div id="summary">
    <p id="price-usd"></p>
    <p id="price-aed"></p>
    <p id="purchase-info"></p>
  </div>
  <div id="qr"></div>
  <div id="form">
    <select id="network-select"></select>
    <label for="email-input" class="required">Email (for receipt &amp; updates)</label>
    <input id="email-input" type="email" placeholder="Email" required>
    <label for="agent-code-input">Agent Code (optional)</label>
    <input id="agent-code-input" type="text" placeholder="Referral code">
    <button id="connect-btn" class="wp-block-button__link">Connect Wallet</button>
    <button id="disconnect-btn" class="wp-block-button__link" style="display:none;">Disconnect</button>
    <button id="pay-btn" class="wp-block-button__link" disabled>Pay</button>
  </div>
  <pre id="msg"></pre>
  <div id="post-pay" style="display:none;">
    <div id="tx-details"></div>
    <button id="schedule-btn" class="wp-block-button__link">Schedule Call</button>
    <button id="copy-btn" class="wp-block-button__link">Copy Payment Details</button>
    <p>
      Thank you! Your Expression of Interest is recorded.<br>
      SQMU tokens will be delivered once the investment round opens.<br>
      A receipt has been emailed. Need help? <a href="mailto:vincent@sqmu.net">Contact support</a>.
    </p>
  </div>
  </div>
  <div id="info" style="margin-top:2em;">
    <div id="sqmu-payment-guide" style="max-width: 640px; text-align: left; margin: 0 auto 2em auto;">
      <h3>Payment Instructions</h3>
      <p>You are completing a payment to register your <strong>Expression of Interest</strong> in purchasing SQMU tokens for this property.</p>
      <p>Each SQMU represents one square metre. You are paying <strong>10 USD per SQMU</strong> to signal your interest only. No final purchase is made at this stage.</p>
      <p>When this property is open for full investment, you will be notified by email and invited to complete the acquisition.</p>

      <h4>How to Pay</h4>
      <ol>
        <li>Connect your wallet. MetaMask on Chrome provides the best experience.</li>
        <li>Select your preferred token and network.</li>
        <li>Enter your email address. This is required to:
          <ul>
            <li>Receive your receipt</li>
            <li>Be notified when the investment opens</li>
            <li>Get follow-up assistance</li>
          </ul>
        </li>
        <li>Confirm the transaction.</li>
      </ol>
      <p>If you use the QR code to pay manually, no email receipt will be sent.</p>

      <h4>After Payment</h4>
      <ul>
        <li>Transaction confirmation will be displayed on screen</li>
        <li>A receipt will be emailed to you</li>
        <li>You may schedule a follow-up call</li>
        <li>You will receive a blockchain transaction link for your records</li>
      </ul>
      <p>Tokens will be delivered manually within 24 hours once investment opens and the final purchase is confirmed.</p>
    </div>
  </div>
    </div>

  <script src="https://unpkg.com/@walletconnect/web3-provider@1/dist/umd/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const MAIL_URL = 'https://script.google.com/macros/s/AKfycbxVdHsuXsvhTsEXcOV4HE9mBqtWF1CQYxRBxUlMJgfHKZFt_LY7Q-bwoF0B5XatlOBS/exec';
    // === CONFIGURATION ===
    const PAYMENT_OPTIONS = [
      { token: 'USDT', name: 'Scroll', chainId: 534352, rpc: 'https://rpc.scroll.io', address: '0xf55BEC9cafDbE8730f096Aa55dad6D22d44099Df', decimals: 6 },
      { token: 'USDC', name: 'Scroll', chainId: 534352, rpc: 'https://rpc.scroll.io', address: '0x06eFdBFf2a14a7c8E15944D1F4A48F9F95F663A4', decimals: 6 },
      { token: 'USDQ', name: 'Scroll', chainId: 534352, rpc: 'https://rpc.scroll.io', address: '0xdb9E8F82D6d45fFf803161F2a5f75543972B229a', decimals: 18 }
    ];

    const EXPLORERS = {
      534352: 'https://scrollscan.com'
    };

    const DEST = '0x43F3f03d89290358034993aE3B3938D056D76De2';
    const DEFAULT_PROP = { decimals: 2, price: 0.01 };
    let PROP = { ...DEFAULT_PROP };
    // Current proxy address, see notes/deployment_log.md for updates
    let SALE_ADDR = '0x19d8D25DD4C85264B2AC502D66aEE113955b8A07';

    const CHAIN_INFO = {
      534352: {
        chainName: 'Scroll',
        rpcUrls: ['https://rpc.scroll.io'],
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
        blockExplorerUrls: ['https://scrollscan.com']
      }
    };

    // === STATE ===
    let provider = null;
    let signer = null;
    let currentWallet = null; // 'metamask' or 'walletconnect'
    let gParams = null;

    // === UI UTILS ===
    function show(msg) {
      document.getElementById('msg').textContent = msg;
    }

    function enablePayBtn(enabled) {
      const emailOk = document.getElementById('email-input').validity.valid;
      document.getElementById('pay-btn').disabled = !(enabled && emailOk);
    }


    function sendReceipt(payLink, amount, option, email, tokenAmt, tokenId, tokenAddr, dec, sqmuLink, fail) {
      fetch(MAIL_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          to_email: email,
          tx_link: payLink,
          usd: amount,
          chain: option.name,
          token: option.token,
          token_amt: tokenAmt,
          token_id: tokenId,
          token_addr: tokenAddr,
          token_dec: dec,
          sqmu_link: sqmuLink,
          prop: tokenId,
          sqmu_amt: gParams ? gParams.get('sqmu') || '' : '',
          agent: document.getElementById('agent-code-input').value.trim(),
          fail: fail ? '1' : ''
        }).toString()
      });
    }

    // === WALLET CONNECTION LOGIC ===
    let mmSdk = null;
    async function setupWallet(kind) {
      if (kind === 'metamask') {
        if (!mmSdk) {
          mmSdk = new MetaMaskSDK.MetaMaskSDK();
        }
        if (!mmSdk.isInitialized()) {
          await mmSdk.init();
        }
        const mmProvider = mmSdk.getProvider();
        if (!mmProvider) {
          show('MetaMask provider unavailable');
          throw new Error('MetaMask provider unavailable');
        }
        provider = new ethers.providers.Web3Provider(mmProvider);
        await mmSdk.connect();
        signer = provider.getSigner();
        currentWallet = 'metamask';
        return;
      }
      if (kind === 'walletconnect') {
        const wc = new window.WalletConnectProvider.default({
          rpc: Object.fromEntries(PAYMENT_OPTIONS.map(o => [o.chainId, o.rpc]))
        });
        await wc.enable();
        provider = new ethers.providers.Web3Provider(wc);
        signer = provider.getSigner();
        currentWallet = 'walletconnect';
        return;
      }
      throw new Error('No wallet found');
    }

    async function disconnectWallet(suppressMsg = false) {
      if (currentWallet === 'walletconnect' && provider?.provider?.disconnect) {
        try { await provider.provider.disconnect(); } catch (e) { /* ignore */ }
      }
      if (currentWallet === 'metamask' && mmSdk?.terminate) {
        try { await mmSdk.terminate(); } finally { mmSdk = null; }
      }
      provider = null;
      signer = null;
      currentWallet = null;
      enablePayBtn(false);
      document.getElementById('disconnect-btn').style.display = 'none';
      if (!suppressMsg) show('Wallet disconnected');
    }

    // === NETWORK SWITCHING ===
    async function switchNetwork(token) {
      if (currentWallet === 'metamask' && window.ethereum) {
        // wallet_switchEthereumChain requires chainId without leading zeros
        const hex = ethers.utils.hexStripZeros(
          ethers.utils.hexlify(token.chainId)
        );
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: hex }]
          });
        } catch (err) {
          if (err.code === 4902) {
            // Not added yet, try to add
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{ chainId: hex, ...CHAIN_INFO[token.chainId] }]
            });
            // Then switch
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: hex }]
            });
          } else {
            throw err;
          }
        }
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        return;
      }

      if (currentWallet === 'walletconnect') {
        // WalletConnect handles network switching internally; make sure to refresh provider & signer
        provider = new ethers.providers.Web3Provider(provider.provider);
        signer = provider.getSigner();
        return;
      }

      throw new Error('No wallet/provider to switch network');
    }

    async function ensureCorrectNetwork(token) {
      if (!provider) throw new Error('No wallet/provider connected');
      const network = await provider.getNetwork();
      if (Number(network.chainId) !== Number(token.chainId)) {
        throw new Error(`Your wallet is on the wrong network. Please switch to ${token.name} (${token.chainId})`);
      }
    }

    // === ERC-20 PAYMENT LOGIC ===
    function getErc20(token) {
      const abi = [
        'function balanceOf(address) view returns (uint256)',
        'function transfer(address,uint256) returns (bool)'
      ];
      return new ethers.Contract(token.address, abi, signer);
    }

    async function sendToken(token, to, amt) {
      await ensureCorrectNetwork(token);
      const erc20 = getErc20(token);
      const data = erc20.interface.encodeFunctionData(
        'transfer',
        [to, ethers.utils.parseUnits(String(amt), token.decimals)]
      );
      const tx = await signer.sendTransaction({
        to: token.address,
        data,
        gasLimit: 70000
      });
      return tx.wait();
    }

    // Check SQMU supply on sale chain treasury
    async function checkSqmuSupply(usdAmount) {
      const saleChain = Number(window.BUY_CHAIN) || 534352;
      const rpc = (PAYMENT_OPTIONS.find(o => o.chainId === saleChain) || {}).rpc || 'https://rpc.scroll.io';
      const readProv = new ethers.providers.JsonRpcProvider(rpc);
      const distAbi = ['function getAvailable(string) view returns(uint256)'];
      const dist = new ethers.Contract(SALE_ADDR, distAbi, readProv);
      const bal = await dist.getAvailable(PROP.code);
      const tokensNeeded = PROP.price ? usdAmount / PROP.price : 0;
      const needed = ethers.utils.parseUnits(String(tokensNeeded), PROP.decimals);
      return bal >= needed;
    }

    // Call Scroll contract to distribute SQMU from treasury
    async function sendSqmu(option, usdPaid, code) {
      const saleChain = Number(window.BUY_CHAIN) || 534352;
      const current = await provider.getNetwork();
      if (Number(current.chainId) !== saleChain) {
        const chainOpt = PAYMENT_OPTIONS.find(o => o.chainId === saleChain) || { chainId: saleChain };
        await switchNetwork(chainOpt);
        await ensureCorrectNetwork({ chainId: saleChain, name: chainOpt.name || 'Scroll' });
      }

      const abi = ['function distribute(string,address,uint256,string)'];
      const sale = new ethers.Contract(SALE_ADDR, abi, signer);
      const to = await signer.getAddress();
      const tokenAmt = PROP.price ? usdPaid / PROP.price : 0;
      const tx = await sale.distribute(PROP.code, to, ethers.utils.parseUnits(String(tokenAmt), PROP.decimals), code);
      return tx.wait();
    }

    // === MAIN UI HANDLING ===
    document.addEventListener('DOMContentLoaded', async () => {
      const postPay = document.getElementById('post-pay');
      const txDetails = document.getElementById('tx-details');
      const form = document.getElementById('form');
      const infoPanel = document.getElementById('info');
      const agentInput = document.getElementById('agent-code-input');
      const emailInput = document.getElementById('email-input');
      emailInput.oninput = () => enablePayBtn(!!(provider && signer));
      function copyDetails() {
        const text = txDetails.textContent || document.getElementById('msg').textContent;
        navigator.clipboard.writeText(text);
      }
      document.getElementById('copy-btn').onclick = copyDetails;
      document.getElementById('schedule-btn').onclick = () => {
        Calendly.initPopupWidget({url: 'https://calendly.com/vincent-sqmu/30min'});
        return false;
      };
      // Setup UI with params
      let search = location.search;
      if (!search && location.hash.includes('?')) {
        search = location.hash.substring(location.hash.indexOf('?'));
      }
      const params = new URLSearchParams(search);
      gParams = params;
      const usdVal = params.get('usd');
      const sqmuVal = params.get('sqmu');
      let aedVal = params.get('aed');
      if (!aedVal && usdVal) {
        aedVal = (parseFloat(usdVal) * 3.67).toFixed(2);
      }
      document.getElementById('prop-title').textContent = params.get('title') || '';
      document.getElementById('price-aed').textContent = aedVal ? `AED ${aedVal}` : '';
      document.getElementById('price-usd').textContent = usdVal ? `USD ${usdVal}` : '';
      document.getElementById('purchase-info').textContent = sqmuVal ? `You are purchasing ${sqmuVal} SQMU tokens.` : '';
      agentInput.value = params.get('agent') || params.get('ref') || '';

      const buyToken = params.get('buy') || params.get('code') || '';
      const buyChain = Number(params.get('buyChain'));
      PROP = {
        code: buyToken,
        address: params.get('sqmuAddr') || '',
        decimals: params.get('sqmuDec') ? Number(params.get('sqmuDec')) : DEFAULT_PROP.decimals,
        price: params.get('rate') ? parseFloat(params.get('rate')) : DEFAULT_PROP.price
      };
      if (params.get('saleAddr')) SALE_ADDR = params.get('saleAddr');
      window.BUY_TOKEN = buyToken;
      window.BUY_CHAIN = buyChain;

      // Populate network selector
      const select = document.getElementById('network-select');
      PAYMENT_OPTIONS.forEach((o, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${o.token} (${o.name})`;
        select.appendChild(opt);
      });

      // Preselect network based on ?token= and ?chain=
      let idx = -1;
      const tokenParam = params.get('token');
      const chainParam = params.get('chain');
      if (tokenParam && chainParam) {
        idx = PAYMENT_OPTIONS.findIndex(o =>
          o.token.toLowerCase() === tokenParam.toLowerCase() &&
          String(o.chainId) === chainParam
        );
      }
      if (idx === -1 && chainParam) {
        idx = PAYMENT_OPTIONS.findIndex(o => String(o.chainId) === chainParam);
      }
      if (idx === -1 && tokenParam) {
        idx = PAYMENT_OPTIONS.findIndex(o => o.token.toLowerCase() === tokenParam.toLowerCase());
      }
      if (idx >= 0) {
        select.value = String(idx);
      }

      // Setup QR code for manual payment
      new QRCode(document.getElementById('qr'), DEST);

      // Connect Wallet
      document.getElementById('connect-btn').onclick = async () => {
        enablePayBtn(false);
        show('Connecting...');
        try {
          // Connect wallet (MetaMask only here, could add WalletConnect as a dropdown/option)
          await setupWallet('metamask');
          const option = PAYMENT_OPTIONS[select.value];
          // Switch to selected network after connection
          await switchNetwork(option);
          await ensureCorrectNetwork(option);
          document.getElementById('disconnect-btn').style.display = '';
          document.getElementById('disconnect-btn').onclick = async () => { await disconnectWallet(); };
          show('Wallet connected to ' + option.name);
          enablePayBtn(true);
        } catch (err) {
          show('Connection or network switch failed:\n' + (err.message || err));
          await disconnectWallet(true);
        }
      };

      // Pay
      document.getElementById('pay-btn').onclick = async () => {
        enablePayBtn(false);
        const option = PAYMENT_OPTIONS[select.value];
        const amount = Number(params.get('usd'));
        if (!Number.isFinite(amount) || amount <= 0) {
          show('Invalid USD amount');
          return;
        }
        try {
          show('Checking network...');
          await switchNetwork(option);
          await ensureCorrectNetwork(option);
        const network = await provider.getNetwork();
        show(`Sending ${amount} ${option.token} to ${DEST} on chain ${network.chainId}...`);
        const receipt = await sendToken(option, DEST, amount);
        const payLink = `${EXPLORERS[option.chainId]}/tx/${receipt.hash}`;
        const tokenAmt = PROP.price ? amount / PROP.price : '';
        show(`âœ… Sent ${amount} ${option.token} to ${DEST} on ${option.name}\n\nView transaction: ${payLink}\nSQMU tokens will be delivered within 24 hours. Receipt will be emailed to you.`);
        txDetails.textContent = `Payment: ${payLink}`;
        postPay.style.display = '';
        if (form) form.style.display = 'none';
        if (infoPanel) infoPanel.style.display = 'none';
        sendReceipt(payLink, amount, option, emailInput.value, tokenAmt, PROP.code, PROP.address, PROP.decimals, '', '');
        } catch (err) {
          show('Payment failed:\n' + (err.message || err));
        }
        enablePayBtn(true);
      };

      // Network select: on change, try to switch wallet network if already connected
      select.onchange = async () => {
        if (provider && signer && currentWallet) {
          const option = PAYMENT_OPTIONS[select.value];
          try {
            await switchNetwork(option);
            await ensureCorrectNetwork(option);
            show(`Switched to ${option.name}`);
            enablePayBtn(true);
          } catch (err) {
            show('Network switch failed:\n' + (err.message || err));
            enablePayBtn(false);
          }
        }
      };

      // Disconnect
      document.getElementById('disconnect-btn').onclick = async () => { await disconnectWallet(); };
    });
</script>
</body>
</html>
