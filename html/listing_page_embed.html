<!-- Embed this file in a WordPress Custom HTML block to avoid entity encoding -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SQMU Purchase</title>
  <style>
    #widget { text-align:center; }
    #widget > * { margin:0.6em 0; }
    label { display:block; margin:0.5em 0 0.2em; }
    select,
    input[type=number] {
      font: inherit;
      padding: 0.6em;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
    }
    .required::after { content:'*'; color:var(--wp--preset--color--primary,#d63638); margin-left:0.25em; }
    #msg { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <div id="widget">
  <h3>Buy SQMU</h3>
  <p id="token-info">Token to receive: <b>SQMU</b> on <b>Scroll</b></p>
  <p>Available: <span id="avail">...</span> SQMU</p>
  <label for="sqmu-input" class="required">SQMU Amount</label>
  <input id="sqmu-input" type="number" min="0.01" step="0.01" placeholder="100">
  <p>USD Amount: <span id="usd-display"></span></p>
  <div>
    <select id="network-select">
      <option value="0xf55BEC9cafDbE8730f096Aa55dad6D22d44099Df">USDT (Scroll)</option>
      <option value="0x06eFdBFf2a14a7c8E15944D1F4A48F9F95F663A4">USDC (Scroll)</option>
      <option value="0xdb9E8F82D6d45fFf803161F2a5f75543972B229a">USDQ (Scroll)</option>
    </select>
  </div>
  <pre id="msg"></pre>
  <p id="manual-info">After continuing you will confirm payment on the next page. A receipt will be emailed and SQMU tokens delivered once the investment round opens.</p>
  <button id="pay-btn" class="wp-block-button__link">Continue to Pay</button>
  <div id="sqmu-brief" style="max-width: 420px; margin-bottom: 1.5em;">
    <h4>Own a Share of This Property</h4>
    <p>Each SQMU equals one square metre of the property.</p>
    <p>You are placing an <strong>Expression of Interest</strong> at <strong>10 USD per SQMU</strong>. This is not a final purchase.</p>
    <p>To proceed:</p>
    <ol>
      <li>Select how many SQMU you are interested in.</li>
      <li>Click “Continue to Pay” to complete the crypto payment on the next page.</li>
    </ol>
    <p><strong>Note for mobile users:</strong> For best results, open this listing inside your wallet app (e.g. MetaMask) so the correct details carry over.</p>
  </div>
  </div>


  <!-- Use the same pinned ethers.js version as other widgets -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // Current proxy address, see notes/deployment_log.md for updates
    let SALE_ADDR = '0x19d8D25DD4C85264B2AC502D66aEE113955b8A07';
    const RPC = 'https://rpc.scroll.io';
    let PROP = { chainId: 534352, decimals: 2 };
    let propertyOk = false;

    function show(msg) {
      document.getElementById('msg').textContent = msg;
    }

    async function fetchPropertyInfo() {
      try {
        const provider = new ethers.providers.JsonRpcProvider(RPC);
        const dist = new ethers.Contract(
          SALE_ADDR,
          ['function properties(string) view returns(address token,address treasury,uint256 price)'],
          provider
        );
        const p = await dist.properties(PROP.code);
        if (p.token !== ethers.constants.AddressZero) {
          PROP.address = p.token;
          PROP.price = Number(p.price) / 1e6;
          propertyOk = true;
          return true;
        }
      } catch (e) {
        console.error(e);
        propertyOk = false;
      }
      propertyOk = false;
      PROP.price = undefined;
      show('SQMU data unavailable');
      return false;
    }

      async function fetchAvailable() {
        try {
          const provider = new ethers.providers.JsonRpcProvider(RPC);
          const sale = new ethers.Contract(SALE_ADDR, ['function getAvailable(string) view returns(uint256)'], provider);
          const bal = await sale.getAvailable(PROP.code);
        const supply = Number(ethers.formatUnits(bal, PROP.decimals));
        document.getElementById('avail').textContent = supply.toLocaleString();
        return supply;
      } catch (e) {
        document.getElementById('avail').textContent = 'N/A';
        show('Unable to fetch available supply');
      }
    }

    function updateUsd() {
      const amt = parseFloat(document.getElementById('sqmu-input').value);
      if (!amt || amt <= 0 || PROP.price === undefined) {
        document.getElementById('usd-display').textContent = '';
        return;
      }
      document.getElementById('usd-display').textContent = (amt * PROP.price).toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const payBtn = document.getElementById('pay-btn');
      payBtn.disabled = true;
      let estCode = '';
      document.querySelectorAll('.es-entity-field').forEach((li) => {
        const label = li.querySelector('.es-property-field__label');
        const value = li.querySelector('.es-property-field__value');
        if (!label || !value) return;
        if (label.textContent.includes('SQMU Property Code')) {
          estCode = value.textContent.trim();
        }
      });
      if (estCode) PROP.code = estCode;
      PROP.decimals = 2;

      let search = location.search;
      if (!search && location.hash.includes('?')) {
        search = location.hash.substring(location.hash.indexOf('?'));
      }
      const params = new URLSearchParams(search);
      const code = params.get('code') || params.get('buy');
      if (code) PROP.code = code;
      if (params.get('addr')) PROP.address = params.get('addr');
      if (params.get('decimals')) PROP.decimals = Number(params.get('decimals'));
      if (params.get('price')) PROP.price = parseFloat(params.get('price'));
      if (params.get('saleAddr')) SALE_ADDR = params.get('saleAddr');
      document.querySelector('h3').textContent = `Buy ${PROP.code}`;
      document.getElementById('token-info').innerHTML = `Token to receive: <b>${PROP.code}</b> on <b>Scroll</b>`;
      document.querySelector('#avail').nextSibling.textContent = ` ${PROP.code}`;
      fetchPropertyInfo().then(async (ok) => {
        if (!ok) {
          payBtn.disabled = true;
          return;
        }
        const supply = await fetchAvailable();
        payBtn.disabled = !(supply > 0);
        setInterval(fetchAvailable, 600000);
      });
      document.getElementById('sqmu-input').oninput = updateUsd;
      document.getElementById('pay-btn').onclick = () => {
        if (!propertyOk) {
          show('Property lookup failed. Please try again later.');
          return;
        }
        const sqmuAmt = parseFloat(document.getElementById('sqmu-input').value);
        if (!sqmuAmt || sqmuAmt <= 0) {
          show('Enter a valid SQMU amount');
          return;
        }
        let usd = '';
        if (PROP.price !== undefined) {
          usd = (sqmuAmt * PROP.price).toFixed(2);
        }
        const idx = document.getElementById('network-select').selectedIndex;
        const tokens = [
          '0xf55BEC9cafDbE8730f096Aa55dad6D22d44099Df', // USDT
          '0x06eFdBFf2a14a7c8E15944D1F4A48F9F95F663A4', // USDC
          '0xdb9E8F82D6d45fFf803161F2a5f75543972B229a'  // USDQ
        ];
        const chains = [534352, 534352, 534352];
        const titleEl = document.querySelector('.property-title');
        const pageTitle = titleEl ? titleEl.textContent : document.title;
        const url = new URL('https://sqmu.net/metamask2');
        url.searchParams.set('title', pageTitle);
        if (usd) url.searchParams.set('usd', usd);
        url.searchParams.set('sqmu', sqmuAmt);
        url.searchParams.set('token', tokens[idx]);
        url.searchParams.set('chain', chains[idx]);
        url.searchParams.set('buy', PROP.code);
        url.searchParams.set('buyChain', PROP.chainId);
        url.searchParams.set('sqmuAddr', PROP.address);
        url.searchParams.set('sqmuDec', PROP.decimals);
        if (PROP.price !== undefined) url.searchParams.set('rate', PROP.price);
        url.searchParams.set('saleAddr', SALE_ADDR);
        window.open(url.toString(), '_blank');
      };
    });
  </script>
</body>
</html>
