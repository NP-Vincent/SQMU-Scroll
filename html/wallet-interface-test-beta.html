<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SQMU Wallet — ESM Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Known-good CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    button { margin-right: 8px; padding: 8px 12px; }
    pre { background:#f5f5f5; padding:12px; overflow:auto; }
    input { padding:8px; width:320px; max-width:100%; }
    .row { margin: 12px 0; }
  </style>
</head>
<body>
  <h2>SQMU Wallet — Test Interface (ESM Web3Auth)</h2>

  <div class="row">
    <button id="mmConnect">Connect MetaMask</button>
    <button id="web3AuthConnect">Sign in with Social</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
  </div>

  <pre id="statusDiv">Disconnected</pre>

  <hr />

  <h3>Check Contract / Account Balance (Scroll)</h3>
  <div class="row">
    <input id="contractAddr" placeholder="0x..." />
    <button id="checkBalance">Check Balance</button>
  </div>
  <pre id="contractStatus"></pre>

  <hr />

  <h3>Debug Log</h3>
  <pre id="debugLog" class="has-small-font-size"></pre>

  <!-- Load Web3Auth as ESM from CDN, then your wallet module -->
  <script type="module">
    // Debug logger
    const debugDiv = document.getElementById('debugLog');
    const log = (...a) => { debugDiv.textContent += a.map(x => (typeof x === 'object' ? JSON.stringify(x) : String(x))).join(' ') + '\n'; };
    ['log','error','warn','info'].forEach(level => {
      const orig = console[level].bind(console);
      console[level] = (...args) => { log(...args); orig(...args); };
    });

    // 1) Import Web3Auth as pure ESM from a CDN (no UMD/global needed)
    // Using esm.sh ensures an ESM-compatible build in the browser.
    const { Web3Auth } = await import('https://esm.sh/@web3auth/modal@10.3.0');
    // Shim the ESM class onto window so wallet-beta.js (which expects a global) can find it
    window.Web3Auth = { Web3Auth };

    console.info('Globals present after ESM import', JSON.stringify({
      ethers: !!window.ethers,
      MetaMaskSDK: !!(window.MetaMaskSDK && (window.MetaMaskSDK.MetaMaskSDK || window.MetaMaskSDK.default)),
      Web3AuthESM: !!Web3Auth,
      Web3AuthGlobalShim: !!(window.Web3Auth && window.Web3Auth.Web3Auth)
    }));

    // 2) Import your wallet logic (expects window.Web3Auth shim + other UMDs)
    //    If hosted elsewhere, replace './wallet-beta.js' with your URL.
    const { connectWallet, disconnectWallet } = await import('https://np-vincent.github.io/SQMU-Scroll/js/wallet-beta.js');
    console.info('wallet-beta.js loaded:', !!connectWallet, !!disconnectWallet);

    // 3) Wire up the UI
    const disconnectBtn = document.getElementById('disconnectBtn');
    const statusDivId   = 'statusDiv';
    let session = null; // { provider, signer, source }

    document.getElementById('mmConnect').addEventListener('click', async () => {
      try {
        session = await connectWallet(statusDivId);              // MetaMask path
        disconnectBtn.dataset.source = session.source;           // 'metamask'
        disconnectBtn.disabled = false;
        console.log('Connected via', session.source);
        await showWho(session);
      } catch (e) { console.error('MetaMask connect error:', e.message || e); }
    });

    document.getElementById('web3AuthConnect').addEventListener('click', async () => {
      try {
        session = await connectWallet(statusDivId, 'web3auth');  // Web3Auth modal path
        disconnectBtn.dataset.source = session.source;           // 'web3auth' | 'web3auth-adapter'
        disconnectBtn.disabled = false;
        console.log('Connected via', session.source);
        await showWho(session);
      } catch (e) { console.error('Web3Auth connect error:', e.message || e); }
    });

    disconnectBtn.addEventListener('click', async () => {
      try { await disconnectWallet(statusDivId, disconnectBtn.dataset.source); }
      finally { session = null; disconnectBtn.disabled = true; console.log('Disconnected'); }
    });

    document.getElementById('checkBalance').addEventListener('click', async () => {
      const out  = document.getElementById('contractStatus');
      const addr = document.getElementById('contractAddr').value.trim();
      if (!addr) return (out.textContent = 'Enter an address.');
      if (!session?.provider) return (out.textContent = 'Connect first.');
      try {
        const code = await session.provider.getCode(addr);
        const kind = code && code !== '0x' ? 'Contract' : 'EOA';
        const wei  = await session.provider.getBalance(addr);
        const eth  = window.ethers.utils.formatEther(wei);
        out.textContent = `${kind} balance: ${eth} ETH`;
      } catch (e) { out.textContent = `Error: ${e.message || e}`; console.error('Balance error:', e); }
    });

    async function showWho(s) {
      try {
        const network = await s.provider.getNetwork();
        const addr    = await s.signer.getAddress();
        console.log('Account:', addr, 'ChainId:', network.chainId);
      } catch (e) { console.warn('Could not fetch account/network:', e.message || e); }
    }
  </script>
</body>
</html>
